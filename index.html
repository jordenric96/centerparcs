<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Spidey Lou">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">

    <title>Lou's Spidey Aftelkalender</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@400;900&display=swap');

        :root {
            --red: #E23636;
            --blue: #013889;
            --black: #1a1a1a;
            --gold: #FFD700;
        }

        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--blue);
            font-family: 'Roboto', sans-serif;
            margin: 0; padding: 10px;
            color: white;
            text-align: center;
            overflow-x: hidden;
            padding-bottom: 80px;
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* HEADER */
        h1 {
            font-family: 'Bangers', cursive;
            font-size: 2.5rem;
            color: var(--red);
            text-shadow: 2px 2px 0 #fff, 4px 4px 0 #000;
            margin: 10px 0;
            animation: bounce 2s infinite;
        }
        .lou-name { color: var(--gold); text-decoration: underline; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* KALENDER GRID */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .day-card {
            background: white;
            border: 4px solid var(--black);
            border-radius: 15px;
            height: 110px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            color: var(--black);
            box-shadow: 0 4px 0 var(--black);
            transition: transform 0.1s;
        }

        .day-card:active { transform: translateY(4px); box-shadow: none; }
        .date-number { font-family: 'Bangers'; font-size: 2.5rem; line-height: 1; z-index: 2;}
        .day-text { font-weight: bold; font-size: 0.8rem; z-index: 2;}
        
        .locked { 
            background: #444; border-color: #222; color: #777; 
            background-image: repeating-linear-gradient(45deg, #333 0, #333 10px, #444 10px, #444 20px);
        }
        .active-day { border-color: var(--red); animation: pulse-border 1s infinite; background: #fff; cursor: pointer;}
        .completed { background: #bbf7d0; border-color: #166534; color: #166534; opacity: 0.8; }
        .completed::after {
            content: "‚úÖ"; position: absolute; font-size: 3rem; opacity: 0.8;
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .final-day { border-color: gold; box-shadow: 0 0 15px gold; }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(226, 54, 54, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(226, 54, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(226, 54, 54, 0); }
        }
        @keyframes pop-in { from {transform: scale(0);} to {transform: scale(1);} }

        /* MODALS */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            flex-direction: column; align-items: center; justify-content: center;
        }

        /* OUDER INSTRUCTIE */
        .parent-instruction-box {
            background: #fff; color: #000; padding: 20px; border-radius: 10px;
            max-width: 90%; text-align: center; border: 5px solid var(--red); position: relative;
        }
        .close-instruction {
            position: absolute; top: -15px; right: -15px; width: 40px; height: 40px;
            background: var(--red); color: white; border-radius: 50%; border: 3px solid white;
            font-weight: bold; font-size: 20px; line-height: 35px; cursor: pointer;
        }

        /* GAME UI */
        #gameArea {
            width: 95%; height: 60vh; max-width: 500px; max-height: 500px;
            background: #222; border: 4px solid white; border-radius: 10px;
            position: relative; overflow: hidden; margin-top: 10px;
            touch-action: none; 
        }

        .hud {
            display: flex; justify-content: space-between; width: 95%; max-width: 500px;
            color: var(--gold); font-family: 'Bangers'; font-size: 1.5rem; margin-top: 10px;
            align-items: center;
        }

        /* EXIT KNOP (KRUISJE) */
        .exit-btn {
            background: #d32f2f; color: white; border: 2px solid white; width: 40px; height: 40px;
            border-radius: 5px; font-weight: bold; font-size: 24px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }

        /* KNOPPEN */
        button.action-btn {
            background: var(--red); color: white; border: none; padding: 15px 30px;
            font-family: 'Bangers'; font-size: 1.5rem; border-radius: 50px;
            margin-top: 15px; cursor: pointer; box-shadow: 0 5px 0 #8b0000;
        }
        button.action-btn:active { transform: translateY(5px); box-shadow: none; }

        /* --- GAME SPECIFIEK --- */
        
        /* Whack-a-Goblin Grid */
        .whack-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
            height: 100%; padding: 10px;
        }
        .whack-hole {
            background: radial-gradient(circle, #000 0%, #333 100%);
            border-radius: 50%; border: 2px solid #555;
            position: relative; overflow: hidden;
        }
        .whack-goblin {
            position: absolute; bottom: -100%; left: 10%; width: 80%; height: 80%;
            font-size: 3rem; text-align: center; transition: bottom 0.1s;
            pointer-events: none; /* Klik op hole, niet op emoji direct */
        }
        .whack-hole.active .whack-goblin { bottom: 0; }
        
        /* Memory */
        .mem-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; height: 100%; padding: 5px; }
        .mem-card { 
            background: var(--blue); border-radius: 5px; display: flex; justify-content: center; align-items: center;
            font-size: 0rem; transition: transform 0.3s; border: 2px solid #fff;
        }
        .mem-card.flipped { background: #fff; font-size: 2.5rem; transform: rotateY(180deg); }
        .mem-card.matched { background: #4CAF50; visibility: visible; animation: pulse 0.5s; font-size: 2.5rem;}

        /* Maze */
        #mazeControls { display: none; gap: 10px; margin-top: 10px; }
        .arrow-btn { 
            width: 60px; height: 60px; background: rgba(255,255,255,0.2); 
            border: 2px solid white; border-radius: 10px; font-size: 24px; color: white;
        }
        .arrow-btn:active { background: var(--red); }
        .maze-cell { display: flex; justify-content: center; align-items: center; font-size: 1.2rem;}
        
        /* Game elements */
        .target { position: absolute; user-select: none; cursor: pointer; }
        .mini-confetti { position: absolute; width: 5px; height: 5px; pointer-events: none; }
        .reset-link { margin-top: 50px; color: #555; font-size: 0.7rem; display: block;}

    </style>
</head>
<body>

    <h1><span class="lou-name">Lou's</span><br>Center Parcs Countdown</h1>
    
    <div id="calendar" class="calendar-grid"></div>

    <div style="margin-top:20px; font-size:0.9rem; opacity:0.8;">
        (Testmodus: Alle dagen zijn open)
    </div>

    <div id="instructionModal" class="modal">
        <div class="parent-instruction-box">
            <div class="close-instruction" onclick="closeAllModals()">‚úï</div>
            <div class="parent-title">üë®‚Äçüë©‚Äçüë¶ Voor Mama/Papa</div>
            <div id="parentText" class="game-desc">Uitleg komt hier...</div>
            <div style="font-size:0.9rem; color:#555; margin-bottom:15px;">(Zet het geluid aan!)</div>
            <button class="action-btn" onclick="startGameReal()">Start Spel!</button>
        </div>
    </div>

    <div id="gameModal" class="modal">
        <div class="hud">
            <span id="scoreDisplay">Score: 0</span>
            <span id="timeDisplay">Tijd: 00</span>
            <button class="exit-btn" onclick="quitGame()">‚úï</button>
        </div>
        
        <div id="gameArea"></div>

        <div id="mazeControls">
            <div></div><button class="arrow-btn" onpointerdown="moveMaze(0, -1)">‚¨ÜÔ∏è</button><div></div>
            <button class="arrow-btn" onpointerdown="moveMaze(-1, 0)">‚¨ÖÔ∏è</button>
            <button class="arrow-btn" onpointerdown="moveMaze(0, 1)">‚¨áÔ∏è</button>
            <button class="arrow-btn" onpointerdown="moveMaze(1, 0)">‚û°Ô∏è</button>
        </div>

        <button id="finishBtn" class="action-btn" style="display:none;" onclick="completeDay()">
            üéâ MISSIE GESLAAGD! üéâ
        </button>
    </div>

    <a class="reset-link" href="#" onclick="hardReset()">Reset Alle Voortgang</a>

<script>
    // --- INSTELLINGEN ---
    
    // ZET DIT LATER OP 'false' OM DE DAGEN TE BLOKKEREN!
    const TEST_MODE = true; 
    
    const TARGET_DATE = new Date(2026, 1, 2); // 2 Feb 2026
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Globals
    let activeIntervals = []; // Om timers netjes te stoppen
    let gameActive = false;
    let score = 0;
    let selectedDateId = '';
    let selectedDayNum = 0;
    let activeMazePos = {x:0, y:0};

    // --- AUDIO ---
    function playTone(freq, type, duration) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }
    const SFX = {
        blip: () => playTone(800, 'sine', 0.1),
        hit:  () => playTone(150, 'square', 0.1),
        bad:  () => playTone(100, 'sawtooth', 0.3),
        good: () => { playTone(1000, 'sine', 0.1); setTimeout(()=>playTone(1500, 'sine', 0.2), 100); },
        win:  () => { [500,600,700,800,1000].forEach((f,i)=>setTimeout(()=>playTone(f,'square',0.2),i*100)); }
    };

    // --- TIMERS BEHEER ---
    function setGameInterval(fn, time) {
        let id = setInterval(fn, time);
        activeIntervals.push({type:'interval', id:id});
        return id;
    }
    function setGameTimeout(fn, time) {
        let id = setTimeout(fn, time);
        activeIntervals.push({type:'timeout', id:id});
        return id;
    }
    function clearAllTimers() {
        activeIntervals.forEach(t => {
            if(t.type === 'interval') clearInterval(t.id);
            else clearTimeout(t.id);
        });
        activeIntervals = [];
    }

    // --- KALENDER ---
    function init() {
        const grid = document.getElementById('calendar');
        grid.innerHTML = '';
        let loopDate = new Date(); // Start rendering vanaf vandaag
        
        // Render tot target date
        while (loopDate <= TARGET_DATE) {
            renderDay(new Date(loopDate));
            loopDate.setDate(loopDate.getDate() + 1);
        }
    }

    function renderDay(dateObj) {
        const today = new Date();
        const isToday = dateObj.getDate() === today.getDate() && dateObj.getMonth() === today.getMonth();
        const dateStr = `${dateObj.getDate()}-${dateObj.getMonth()}`;
        const isDone = localStorage.getItem('lou_cp_' + dateStr) === 'true';
        const isTarget = dateObj.getDate() === 2 && dateObj.getMonth() === 1;

        let statusClass = 'future';
        let clickAction = null;

        if (isDone) statusClass = 'completed';
        else if (isToday || TEST_MODE) { // TEST_MODE zorgt dat alles open is
            statusClass = 'active-day';
            clickAction = () => openInstruction(dateObj.getDate(), dateStr);
        } else if (dateObj < today) statusClass = 'locked'; 
        else statusClass = 'locked';

        if (isTarget) statusClass += ' final-day';

        const el = document.createElement('div');
        el.className = `day-card ${statusClass}`;
        el.innerHTML = `
            <div class="day-text">${dateObj.toLocaleDateString('nl-NL', {weekday:'short'})}</div>
            <div class="date-number">${dateObj.getDate()}</div>
            <div class="day-text">${dateObj.toLocaleDateString('nl-NL', {month:'short'})}</div>
        `;
        if (clickAction) el.onclick = clickAction;
        document.getElementById('calendar').appendChild(el);
    }

    // --- GAME FLOW ---
    function openInstruction(dayNum, dateId) {
        selectedDateId = dateId;
        selectedDayNum = dayNum;
        const modal = document.getElementById('instructionModal');
        const txt = document.getElementById('parentText');
        
        if (dayNum === 2 && new Date().getMonth() === 1) {
            txt.innerHTML = "HET IS ZOVER! Klik op start!";
            modal.style.display = 'flex';
            return;
        }

        const gameIdx = (dayNum % 6) + 1; 
        let uitleg = "";
        
        if(gameIdx === 1) uitleg = "<b>Spel: Whack-a-Goblin</b><br>Tik snel op de Goblins (üë∫) die uit de webben komen. Pas op: ze verdwijnen snel!";
        if(gameIdx === 2) uitleg = "<b>Spel: Spidey Memory</b><br>Zoek twee dezelfde plaatjes. Vind ze allemaal!";
        if(gameIdx === 3) uitleg = "<b>Spel: Bommenwerper</b><br>Bescherm de stad! Tik ALLEEN de bommen (üí£) aan. Cadeautjes (üéÅ) moet je laten vallen.";
        if(gameIdx === 4) uitleg = "<b>Spel: Het Doolhof</b><br>Gebruik de pijltjes om Spidey naar de vlag (üèÅ) te brengen.";
        if(gameIdx === 5) uitleg = "<b>Spel: Web Schieten</b><br>Tik zo snel mogelijk op de roosjes (üéØ) die verschijnen.";
        if(gameIdx === 6) uitleg = "<b>Spel: Spidey Jump</b><br>Tik op het scherm om over de bal te springen!";

        txt.innerHTML = uitleg;
        modal.style.display = 'flex';
    }

    function quitGame() {
        gameActive = false;
        clearAllTimers();
        document.getElementById('gameModal').style.display = 'none';
        document.getElementById('mazeControls').style.display = 'none';
        // Geen 'completeDay' aanroepen, dus dag blijft open
    }
    
    function closeAllModals() {
        document.getElementById('instructionModal').style.display = 'none';
    }

    function startGameReal() {
        closeAllModals();
        const gm = document.getElementById('gameModal');
        gm.style.display = 'flex';
        document.getElementById('finishBtn').style.display = 'none';
        document.getElementById('mazeControls').style.display = 'none';
        
        score = 0;
        gameActive = true;
        clearAllTimers(); // Voor de zekerheid

        if (selectedDayNum === 2 && new Date().getMonth() === 1) {
             document.getElementById('gameArea').innerHTML = "<div style='display:flex;height:100%;align-items:center;justify-content:center;font-size:80px;'>üèä‚Äç‚ôÇÔ∏èüöóüéâ</div>";
             playWinEffect();
             return;
        }

        const gameIdx = (selectedDayNum % 6) + 1;
        if(gameIdx === 1) playGoblinSmash(); // Vernieuwd
        if(gameIdx === 2) playMemory();
        if(gameIdx === 3) playBombs();
        if(gameIdx === 4) playMaze();
        if(gameIdx === 5) playWebShooter();
        if(gameIdx === 6) playJumper();
    }

    // --- GAME 1: WHACK-A-GOBLIN (NIEUW) ---
    function playGoblinSmash() {
        updateHUD(0, 10);
        const area = document.getElementById('gameArea');
        area.innerHTML = '<div class="whack-grid" id="whackGrid"></div>';
        const grid = document.getElementById('whackGrid');
        
        // Maak 9 gaten
        let holes = [];
        for(let i=0; i<9; i++) {
            const h = document.createElement('div');
            h.className = 'whack-hole';
            h.innerHTML = '<div class="whack-goblin">üë∫</div>';
            h.onpointerdown = (e) => {
                e.preventDefault();
                if(h.classList.contains('active')) {
                    SFX.hit();
                    h.classList.remove('active');
                    // Visueel effectje
                    h.style.backgroundColor = 'var(--red)';
                    setTimeout(()=>h.style.backgroundColor='', 100);
                    score++;
                    updateHUD(score, 10);
                    if(score >= 10) endGame();
                }
            };
            grid.appendChild(h);
            holes.push(h);
        }

        function peep() {
            if(!gameActive) return;
            const randomHole = holes[Math.floor(Math.random() * holes.length)];
            randomHole.classList.add('active');
            
            // Verdwijn na tijd (sneller als score hoger is)
            const speed = Math.max(500, 1000 - (score * 50)); 
            
            setGameTimeout(() => {
                randomHole.classList.remove('active');
                if(gameActive && score < 10) {
                    setGameTimeout(peep, Math.random() * 500 + 200);
                }
            }, speed);
        }
        
        peep();
    }

    // --- GAME 2: MEMORY ---
    function playMemory() {
        updateHUD(0, "6 paren");
        const area = document.getElementById('gameArea');
        area.innerHTML = '<div class="mem-grid" id="memGrid"></div>';
        const icons = ['üï∑Ô∏è','üï∏Ô∏è','üë∫','ü¶∏','üèôÔ∏è','‚ö°'];
        let deck = [...icons, ...icons].sort(()=>Math.random()-0.5);
        let first = null; let lock = false; let matches = 0;

        deck.forEach(icon => {
            const card = document.createElement('div');
            card.className = 'mem-card';
            card.dataset.val = icon;
            card.innerText = icon; 
            card.onclick = () => {
                if(lock || card === first || card.classList.contains('matched')) return;
                SFX.blip();
                card.classList.add('flipped');
                if(!first) { first = card; } 
                else {
                    lock = true;
                    if(first.dataset.val === card.dataset.val) {
                        setGameTimeout(() => {
                            SFX.good();
                            first.classList.add('matched'); card.classList.add('matched');
                            spawnMiniConfetti(card.offsetLeft, card.offsetTop);
                            matches++; first = null; lock = false;
                            updateHUD(matches, 6);
                            if(matches === 6) endGame();
                        }, 500);
                    } else {
                        setGameTimeout(() => {
                            SFX.bad();
                            first.classList.remove('flipped'); card.classList.remove('flipped');
                            first = null; lock = false;
                        }, 1000);
                    }
                }
            }
            document.getElementById('memGrid').appendChild(card);
        });
    }

    // --- GAME 3: BOMMEN ---
    function playBombs() {
        let timeLeft = 30;
        updateHUD(0, "Overleef");
        const area = document.getElementById('gameArea');
        area.innerHTML = '';

        setGameInterval(() => {
            timeLeft--;
            document.getElementById('timeDisplay').innerText = "Tijd: " + timeLeft;
            if(timeLeft <= 0) endGame();
        }, 1000);

        function drop() {
            if(!gameActive) return;
            const isBomb = Math.random() > 0.4; 
            const el = document.createElement('div');
            el.innerText = isBomb ? 'üí£' : 'üéÅ';
            el.className = 'target';
            el.style.fontSize = '40px';
            el.style.left = Math.random() * 85 + '%';
            el.style.top = '-50px';
            el.style.transition = 'top 2.5s linear';
            
            area.appendChild(el);
            setGameTimeout(()=> el.style.top = '110%', 50);

            el.onpointerdown = (e) => {
                e.preventDefault();
                if(isBomb) {
                    SFX.good();
                    score++;
                    updateHUD(score, "Go!");
                    el.remove();
                } else {
                    SFX.bad();
                }
            }
            // Nieuwe drop
            setGameTimeout(drop, 800);
        }
        drop();
    }

    // --- GAME 4: DOOLHOF ---
    function playMaze() {
        document.getElementById('mazeControls').style.display = 'flex';
        updateHUD(0, "Naar Vlag");
        const area = document.getElementById('gameArea');
        area.innerHTML = '';
        area.style.display = 'grid';
        area.style.gridTemplateColumns = 'repeat(6, 1fr)';
        area.style.gridTemplateRows = 'repeat(6, 1fr)';

        const map = [[2,0,1,0,0,0],[1,0,1,0,1,1],[0,0,0,0,0,0],[0,1,1,1,1,0],[0,0,0,1,0,0],[1,1,0,0,0,3]];

        for(let y=0; y<6; y++) {
            for(let x=0; x<6; x++) {
                const cell = document.createElement('div');
                cell.className = 'maze-cell';
                if(map[y][x] === 1) cell.style.background = '#555';
                if(map[y][x] === 3) cell.innerText = 'üèÅ';
                cell.id = `cell_${x}_${y}`;
                area.appendChild(cell);
                if(map[y][x] === 2) { activeMazePos = {x,y}; renderPlayer(x,y); }
            }
        }
        window.currentMap = map;
    }

    function moveMaze(dy, dx) {
        if(!gameActive) return;
        const newX = activeMazePos.x + dx;
        const newY = activeMazePos.y + dy;
        const map = window.currentMap;
        if(newX < 0 || newX > 5 || newY < 0 || newY > 5) return;
        if(map[newY][newX] === 1) { SFX.bad(); return; }
        
        SFX.blip();
        document.getElementById(`cell_${activeMazePos.x}_${activeMazePos.y}`).innerHTML = '';
        activeMazePos = {x: newX, y: newY};
        renderPlayer(newX, newY);
        if(map[newY][newX] === 3) endGame();
    }
    function renderPlayer(x,y) { document.getElementById(`cell_${x}_${y}`).innerHTML = 'üï∑Ô∏è'; }

    // --- GAME 5: SHOOTER ---
    function playWebShooter() {
        updateHUD(0, 15);
        const area = document.getElementById('gameArea');
        area.innerHTML = '';
        function spawnTarget() {
            if(!gameActive) return;
            const t = document.createElement('div');
            t.innerText = 'üéØ';
            t.className = 'target';
            t.style.fontSize = '60px';
            t.style.left = Math.random() * 80 + '%';
            t.style.top = Math.random() * 80 + '%';
            
            let to = setGameTimeout(() => {
                if(t.parentNode) t.remove();
                if(gameActive) spawnTarget();
            }, 1000);

            t.onpointerdown = (e) => {
                e.preventDefault();
                clearTimeout(to);
                SFX.good();
                score++;
                updateHUD(score, 15);
                t.remove();
                if(score >= 15) endGame();
                else spawnTarget();
            };
            area.appendChild(t);
        }
        spawnTarget();
    }

    // --- GAME 6: JUMP ---
    function playJumper() {
        updateHUD(0, "5 Sprongen");
        const area = document.getElementById('gameArea');
        area.innerHTML = '';
        
        const floor = document.createElement('div');
        floor.style.cssText = "position:absolute; bottom:0; width:100%; height:20px; background:white;";
        area.appendChild(floor);
        const spidey = document.createElement('div');
        spidey.innerText = 'üï∑Ô∏è';
        spidey.style.cssText = "position:absolute; bottom:20px; left:20px; font-size:50px; transition: bottom 0.3s;";
        area.appendChild(spidey);

        let jumping = false;
        area.onpointerdown = () => {
            if(jumping) return;
            SFX.blip(); jumping = true;
            spidey.style.bottom = "120px";
            setGameTimeout(() => {
                spidey.style.bottom = "20px";
                setGameTimeout(() => jumping = false, 300);
            }, 400);
        };

        function spawnObstacle() {
            if(!gameActive) return;
            const obs = document.createElement('div');
            obs.innerText = '‚öΩ';
            obs.style.cssText = "position:absolute; bottom:20px; right:-50px; font-size:40px; transition: right 2s linear;";
            area.appendChild(obs);
            setGameTimeout(() => obs.style.right = '120%', 50);

            let check = setGameInterval(() => {
                const sRect = spidey.getBoundingClientRect();
                const oRect = obs.getBoundingClientRect();
                if(oRect.left < sRect.right && oRect.right > sRect.left && sRect.bottom > oRect.top) {
                    SFX.bad();
                    obs.remove(); clearInterval(check);
                    score = 0; updateHUD(score, 5);
                }
            }, 50);

            setGameTimeout(() => {
                if(obs.parentNode) {
                    obs.remove(); clearInterval(check);
                    score++; updateHUD(score, 5);
                    if(score >= 5) endGame();
                    else setGameTimeout(spawnObstacle, 1000);
                }
            }, 2100);
        }
        spawnObstacle();
    }

    // --- UTILS ---
    function updateHUD(s, goal) {
        document.getElementById('scoreDisplay').innerText = `Score: ${s}/${goal}`;
    }

    function endGame() {
        gameActive = false;
        clearAllTimers();
        playWinEffect();
    }

    function playWinEffect() {
        SFX.win();
        document.getElementById('finishBtn').style.display = 'block';
        for(let i=0; i<15; i++) setTimeout(() => spawnMiniConfetti(Math.random()*window.innerWidth, Math.random()*window.innerHeight, true), i*100);
    }

    function spawnMiniConfetti(x, y, big = false) {
        const colors = ['#E23636', '#013889', '#FFF', '#FFD700'];
        const c = document.createElement('div');
        c.className = 'mini-confetti';
        c.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
        c.style.left = x + 'px'; c.style.top = y + 'px';
        document.body.appendChild(c);

        const angle = Math.random() * Math.PI * 2;
        const velocity = Math.random() * (big ? 200 : 100);
        const destX = x + Math.cos(angle) * velocity;
        const destY = y + Math.sin(angle) * velocity;

        c.animate([
            { transform: `translate(0,0) scale(1)`, opacity: 1 },
            { transform: `translate(${destX - x}px, ${destY - y}px) scale(0)`, opacity: 0 }
        ], { duration: 800 + Math.random() * 500, fill: 'forwards' }).onfinish = () => c.remove();
    }

    function completeDay() {
        document.getElementById('gameModal').style.display = 'none';
        if (selectedDateId) localStorage.setItem('lou_cp_' + selectedDateId, 'true');
        init();
        SFX.win();
        spawnMiniConfetti(window.innerWidth/2, window.innerHeight/2, true);
    }

    function hardReset() {
        if(confirm("Alles wissen?")) { localStorage.clear(); location.reload(); }
    }

    init();
</script>
</body>
</html>
